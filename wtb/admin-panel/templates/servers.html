{% extends 'base.html' %}

{% block title %}Servers Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">WireGuard Servers</h1>
    
    <!-- Overview Cards -->
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Servers</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ servers|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-server fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Active Servers</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ active_servers }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Peers</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_peers }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Locations</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ locations }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-globe fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Servers Table Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Remote Servers</h6>
            <!-- <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addServerModal">
                <i class="fas fa-plus fa-sm"></i> Add Server
            </button> -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServerModal">
                <i class="bi bi-plus-circle"></i> Добавить сервер
            </button>  

        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="serversTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Geolocation</th>
                            <th>URL</th>
                            <th>Status</th>
                            <th>Peers</th>
                            <th>Load</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for server in servers %}
                        <tr>
                            <td>{{ server.name }}</td>
                            <td>{{ server.location }}</td>
                            <td>{{ server.geolocation_name }}</td>
                            <td>{{ server.api_url }}</td>
                            <td>
                                {% if server.is_active %}
                                <span class="badge badge-success">Active</span>
                                {% else %}
                                <span class="badge badge-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>{{ server.peers_count|default('0') }}</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: {{ server.load|default('0') }}%"
                                         aria-valuenow="{{ server.load|default('0') }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ server.load|default('0') }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-info" 
                                            onclick="location.href='/servers/details/{{ server.id }}'">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            data-toggle="modal" data-target="#editServerModal" 
                                            data-server-id="{{ server.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" 
                                            data-toggle="modal" data-target="#deleteServerModal" 
                                            data-server-id="{{ server.id }}" data-server-name="{{ server.name }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Server Status Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Servers Status</h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% for server in server_status %}
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-{{ 'success' if server.status == 'online' else 'danger' }} shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-{{ 'success' if server.status == 'online' else 'danger' }} text-uppercase mb-1">
                                        {{ server.name }}
                                    </div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ server.location }}</div>
                                    <div class="small text-gray-600">
                                        {% if server.status == 'online' %}
                                            <span class="text-success">
                                                <i class="fas fa-circle fa-sm"></i> Online
                                            </span>
                                            <span class="ml-2">{{ server.peers_count }} peers</span>
                                            <span class="ml-2">{{ server.response_time|round(2) }}ms</span>
                                        {% else %}
                                            <span class="text-danger">
                                                <i class="fas fa-times-circle fa-sm"></i> Offline
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-server fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add Server Modal -->
<div class="modal fade" id="addServerModal" tabindex="-1" role="dialog" aria-labelledby="addServerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServerModalLabel">Add New Server</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addServerForm" action="/servers/add" method="post">
                <div class="modal-body">
                    <div class="form-group row">
                        <div class="col-sm-6 mb-3">
                            <label for="name">Server Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label for="location">Location</label>
                            <input type="text" class="form-control" id="location" name="location" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-6 mb-3">
                            <label for="api_url">API URL</label>
                            <input type="url" class="form-control" id="api_url" name="api_url" required>
                            <small class="form-text text-muted">Full URL to the WireGuard server API (e.g., http://example.com:5000)</small>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label for="geolocation_id">Geolocation</label>
                            <select class="form-control" id="geolocation_id" name="geolocation_id" required>
                                <option value="">Select Geolocation</option>
                                {% for geolocation in geolocations %}
                                <option value="{{ geolocation.id }}">{{ geolocation.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-6 mb-3">
                            <label for="auth_type">Authentication Type</label>
                            <select class="form-control" id="auth_type" name="auth_type" onchange="toggleAuthFields()">
                                <option value="api_key">API Key</option>
                                <option value="oauth">OAuth</option>
                                <option value="hmac">HMAC</option>
                            </select>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label for="max_peers">Maximum Peers</label>
                            <input type="number" class="form-control" id="max_peers" name="max_peers" value="100" min="1">
                        </div>
                    </div>
                    
                    <!-- API Key Authentication -->
                    <div id="api_key_auth">
                        <div class="form-group">
                            <label for="api_key">API Key</label>
                            <input type="password" class="form-control" id="api_key" name="api_key">
                        </div>
                    </div>
                    
                    <!-- OAuth Authentication -->
                    <div id="oauth_auth" style="display: none;">
                        <div class="form-group row">
                            <div class="col-sm-6 mb-3">
                                <label for="oauth_client_id">Client ID</label>
                                <input type="text" class="form-control" id="oauth_client_id" name="oauth_client_id">
                            </div>
                            <div class="col-sm-6 mb-3">
                                <label for="oauth_client_secret">Client Secret</label>
                                <input type="password" class="form-control" id="oauth_client_secret" name="oauth_client_secret">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="oauth_token_url">Token URL</label>
                            <input type="url" class="form-control" id="oauth_token_url" name="oauth_token_url">
                        </div>
                    </div>
                    
                    <!-- HMAC Authentication -->
                    <div id="hmac_auth" style="display: none;">
                        <div class="form-group">
                            <label for="hmac_secret">HMAC Secret</label>
                            <input type="password" class="form-control" id="hmac_secret" name="hmac_secret">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="is_active" name="is_active" checked>
                            <label class="custom-control-label" for="is_active">Active</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Server</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Server Modal -->
<div class="modal fade" id="editServerModal" tabindex="-1" role="dialog" aria-labelledby="editServerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editServerModalLabel">Edit Server</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editServerForm" action="/servers/edit" method="post">
                <input type="hidden" id="edit_server_id" name="server_id">
                <div class="modal-body">
                    <!-- Форма редактирования, аналогичная форме добавления -->
                    <!-- Поля предзаполняются через JavaScript при открытии модального окна -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Server Modal -->
<div class="modal fade" id="deleteServerModal" tabindex="-1" role="dialog" aria-labelledby="deleteServerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteServerModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete server <span id="delete_server_name"></span>?</p>
                <p class="text-danger">This action cannot be undone. All peers on this server will be lost.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <form id="deleteServerForm" action="/servers/delete" method="post">
                    <input type="hidden" id="delete_server_id" name="server_id">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // $(document).ready(function() {
    //     // Initialize DataTable
    //     $('#serversTable').DataTable();
        
    //     // Обработчик открытия модального окна редактирования
    //     $('#addServerModal').on('show.bs.modal', function (event) {
    //         console.log('Add Server Modal opened');
    //         // Можно добавить дополнительную логику инициализации, если нужно
    //     });

    //     // Функция для переключения видимости полей аутентификации
    //     window.toggleAuthFields = function() {
    //         var authType = document.getElementById('auth_type').value;
        
    //         document.getElementById('api_key_auth').style.display = 'none';
    //         document.getElementById('oauth_auth').style.display = 'none';
    //         document.getElementById('hmac_auth').style.display = 'none';
            
    //         if (authType === 'api_key') {
    //             document.getElementById('api_key_auth').style.display = 'block';
    //         } else if (authType === 'oauth') {
    //             document.getElementById('oauth_auth').style.display = 'block';
    //         } else if (authType === 'hmac') {
    //             document.getElementById('hmac_auth').style.display = 'block';
    //         }
    //     };
        
    //     // Инициализация видимости полей аутентификации
    //     toggleAuthFields();
    // });





    // $(document).ready(function() {
    //     // Initialize DataTable
    //     $('#serversTable').DataTable();
        
    //     // Обработчик открытия модального окна редактирования
    //     $('#editServerModal').on('show.bs.modal', function (event) {
    //         var button = $(event.relatedTarget);
    //         var serverId = button.data('server-id');
    //         var modal = $(this);
            
    //         // Загрузка данных сервера через AJAX
    //         $.ajax({
    //             url: '/servers/get/' + serverId,
    //             type: 'GET',
    //             success: function(data) {
    //                 // Заполнение формы данными
    //                 modal.find('#edit_server_id').val(data.server.id);
    //                 // Заполнение остальных полей...
    //             }
    //         });
    //     });
        
        // Обработчик открытия модального окна удаления
//         $('#deleteServerModal').on('show.bs.modal', function (event) {
//             var button = $(event.relatedTarget);
//             var serverId = button.data('server-id');
//             var serverName = button.data('server-name');
//             var modal = $(this);
            
//             modal.find('#delete_server_id').val(serverId);
//             modal.find('#delete_server_name').text(serverName);

        
//         // Функция для переключения видимости полей аутентификации
//         window.toggleAuthFields = function() {
//             var authType = $('#auth_type').val();
            
//             $('#api_key_auth, #oauth_auth, #hmac_auth').hide();
            
//             if (authType === 'api_key') {
//                 $('#api_key_auth').show();
//             } else if (authType === 'oauth') {
//                 $('#oauth_auth').show();
//             } else if (authType === 'hmac') {
//                 $('#hmac_auth').show();
//             }
//         };
        
//         // Инициализация видимости полей аутентификации
//         toggleAuthFields();
//     });

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');

    // Проверка элементов
    const addServerButton = document.querySelector('[data-bs-target="#addServerModal"]');
    const addServerModal = document.getElementById('addServerModal');
    const authTypeSelect = document.getElementById('auth_type');

    console.log('Add Server Button:', addServerButton);
    console.log('Add Server Modal:', addServerModal);
    console.log('Auth Type Select:', authTypeSelect);

    // Проверка событий Bootstrap
    if (addServerModal) {
        addServerModal.addEventListener('show.bs.modal', function (event) {
            console.log('Modal show event triggered');
        });
        addServerModal.addEventListener('shown.bs.modal', function (event) {
            console.log('Modal shown event triggered');
        });
    }

    // Принудительная регистрация событий
    if (addServerButton) {
        addServerButton.addEventListener('click', function(e) {
            console.log('Add Server Button clicked');
            console.log('Event target:', e.target);
        });
    }
});

// Глобальный перехват событий
document.addEventListener('click', function(e) {
    if (e.target.matches('[data-bs-target="#addServerModal"]')) {
        console.log('Clicked element details:', {
            target: e.target,
            attributes: Array.from(e.target.attributes).map(attr => attr.name)
        });
    }
});
</script>
{% endblock %}