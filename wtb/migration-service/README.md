# Migration Service для VPN Duck

Сервис для автоматической миграции пользователей между серверами при обнаружении проблем с доступностью.

## Функциональность

Сервис выполняет следующие задачи:

1. **Мониторинг доступности серверов:**
   - Регулярная проверка доступности серверов через ping
   - Измерение задержки (latency)
   - Измерение потери пакетов (packet loss)
   - Отслеживание последовательных сбоев

2. **Автоматическая миграция пользователей:**
   - Обнаружение недоступных серверов
   - Поиск оптимальных серверов для миграции
   - Миграция пользователей с недоступных серверов
   - Регистрация событий миграции в журнале

3. **Обновление статуса серверов:**
   - Изменение статуса недоступных серверов в базе данных
   - Возвращение серверов в рабочий статус при восстановлении

## Настройка

Сервис поддерживает следующие переменные окружения:

- `DATABASE_SERVICE_URL` - URL сервиса базы данных (по умолчанию: `http://database-service:5002`)
- `WIREGUARD_SERVICE_URL` - URL сервиса WireGuard (по умолчанию: `http://wireguard-service:5001`)
- `CHECK_INTERVAL` - Интервал проверки серверов в секундах (по умолчанию: `300` - 5 минут)
- `MIGRATION_THRESHOLD` - Количество последовательных сбоев до миграции (по умолчанию: `3`)
- `PING_COUNT` - Количество пингов для проверки доступности (по умолчанию: `5`)
- `PING_TIMEOUT` - Таймаут пинга в секундах (по умолчанию: `3`)
- `PACKET_LOSS_THRESHOLD` - Порог потери пакетов для миграции (по умолчанию: `50.0`)
- `LATENCY_THRESHOLD` - Порог задержки для миграции в миллисекундах (по умолчанию: `300.0`)
- `STARTUP_DELAY` - Задержка запуска в секундах (по умолчанию: `30`)

## Интеграция с VPN Duck

Сервис интегрируется с существующей инфраструктурой VPN Duck через API:

- Использует `/servers/all` для получения списка серверов
- Использует `/servers/{server_id}/connections` для получения активных подключений
- Использует `/servers/{server_id}/status` для обновления статуса сервера
- Использует `/configs/change_geolocation` для миграции пользователей
- Использует `/server_migrations/log` для регистрации миграций

## Развертывание

Сервис настроен для автоматического запуска в составе Docker Compose. Он будет автоматически собираться и запускаться вместе с остальными сервисами.

```bash
docker-compose up -d
```

## Мониторинг

Для мониторинга работы сервиса можно использовать журналы Docker:

```bash
docker-compose logs -f migration-service
```